name: Install .NET Core SDK
description: Installs a specified .NET Core SDK version

inputs:
  dotnet-version:
    description: The version of .NET SDK to install (e.g., 3.1.426)
    required: true
  architecture:
    description: Target architecture (e.g., x64 or arm64)
    required: true

runs:
  using: "composite"
  steps:
    - name: Resolve .NET Core SDK Version
      shell: bash
      env:
        RAW_INPUT: ${{ inputs.dotnet-version }}
      run: |
        DOTNET_CHANNEL="${RAW_INPUT%%.x}"

        RELEASE_INDEX_URL="https://builds.dotnet.microsoft.com/dotnet/release-metadata/releases-index.json"

        # Get the URL to the channel-specific releases.json
        RELEASES_JSON_URL=$(curl -s $RELEASE_INDEX_URL \
          | jq -r --arg ver "$DOTNET_CHANNEL" '
              .["releases-index"][]
              | select(.["channel-version"] == $ver)
              | ."releases.json"')

        if [ -z "$RELEASES_JSON_URL" ]; then
        echo "Could not resolve releases.json URL for channel $DOTNET_CHANNEL"
        exit 1
        fi
        
        # Download and extract latest SDK version
        DOTNET_VERSION=$(curl -s $RELEASES_JSON_URL \
          | jq -r '
              .releases[]
              | select(.sdk.version != null)
              | .sdk.version' \
          | sort -Vr \
          | head -n1)

        if [ -z "$DOTNET_VERSION" ]; then
        echo "Could not resolve SDK version from $RELEASES_JSON_URL"
        exit 1
        fi
        
        echo "Resolved full SDK version: $DOTNET_VERSION"
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_ENV

    - name: Install .NET Core SDK [ ${{ inputs.dotnet-version }} ]
      shell: bash
      run: |
        ARCHITECTURE="${{ inputs.architecture }}"
        INSTALL_DIR=$HOME/dotnet

        echo "Installing .NET SDK $DOTNET_VERSION for $ARCHITECTURE..."
        mkdir -p "$INSTALL_DIR"
        curl -sSL https://dotnet.microsoft.com/download/dotnet/scripts/v1/dotnet-install.sh -o dotnet-install.sh
        chmod +x dotnet-install.sh
        ./dotnet-install.sh --version "$DOTNET_VERSION" --install-dir "$INSTALL_DIR" --architecture "$ARCHITECTURE"

    - name: Add dotnet to PATH
      shell: bash
      run: echo "$HOME/dotnet" >> $GITHUB_PATH

    - name: Check .NET SDK
      shell: bash
      run: |
        dotnet --info